pipeline {
    agent any

    triggers {
        pollSCM('H/2 * * * *')  // Revisa cambios cada 2 minutos
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        skipDefaultCheckout(true)
    }

    environment {
        // Usa el que tengas instalado en el host de Jenkins:
        // Para Docker Compose plugin nuevo:
        DOCKER_COMPOSE_CMD = 'docker compose'
        // Si usas el binario viejo: 'docker-compose'
        // DOCKER_COMPOSE_CMD = 'docker-compose'
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Limpiando workspace..."
                deleteDir()
                echo "Clonando repositorio..."
                git branch: 'main',
                    url: 'https://github.com/jhossedmolina/eLibrary.git'
            }
        }

        stage('Build imagen Django') {
            steps {
                sh '''
                    # Limpiar por si qued√≥ algo de un build anterior
                    ${DOCKER_COMPOSE_CMD} down -v || true

                    echo "Construyendo la imagen del servicio web..."
                    ${DOCKER_COMPOSE_CMD} build --no-cache web
                '''
            }
        }

        stage('Levantar MySQL') {
            steps {
                sh '''
                    echo "Levantando solo el servicio de base de datos..."
                    ${DOCKER_COMPOSE_CMD} up -d db

                    echo "Estado de los contenedores:"
                    ${DOCKER_COMPOSE_CMD} ps
                '''
            }
        }

        stage('Migraciones') {
            steps {
                sh '''
                    echo "Esperando a que la base de datos est√© lista..."
                    sleep 10
                    
                    echo "Ejecutando migraciones dentro del contenedor Django (web)..."
                    ${DOCKER_COMPOSE_CMD} run --rm web sh -c "python manage.py migrate"
                '''
            }
        }

        stage('Pruebas Unitarias') {
            steps {
                sh '''
                    echo "üß™ Ejecutando pruebas unitarias con SQLite..."
                    
                    ${DOCKER_COMPOSE_CMD} run --rm web python run_tests_sqlite.py --verbosity=2 --noinput
                    
                    echo "‚úÖ Pruebas unitarias completadas."
                '''
            }
        }
        
        stage('Reporte de Cobertura') {
            steps {
                sh '''
                    echo "üìä Generando reporte de cobertura..."
                    
                    ${DOCKER_COMPOSE_CMD} run --rm web sh -c "
                        coverage run --source=libros,usuarios,prestamos,core run_tests_sqlite.py --noinput &&
                        coverage report -m &&
                        coverage html
                    "
                    
                    echo "‚úÖ Reporte de cobertura generado."
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    echo "Desplegando aplicaci√≥n..."
                    ${DOCKER_COMPOSE_CMD} up -d
                    
                    echo "Verificando servicios desplegados:"
                    ${DOCKER_COMPOSE_CMD} ps
                    
                    echo "‚úÖ Aplicaci√≥n disponible en http://localhost:8000"
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline exitoso. Aplicaci√≥n desplegada correctamente."
        }
        failure {
            echo "‚ùå Pipeline fall√≥. Ejecutando cleanup..."
            sh '${DOCKER_COMPOSE_CMD} down -v || true'
        }
    }
}