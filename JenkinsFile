pipeline {
    agent any

    triggers {
        pollSCM('H/2 * * * *')  // Revisa cambios cada 2 minutos
    }

    options {
        timestamps()
        disableConcurrentBuilds()
        skipDefaultCheckout(true)
    }

    environment {
        // Usa el que tengas instalado en el host de Jenkins:
        // Para Docker Compose plugin nuevo:
        DOCKER_COMPOSE_CMD = 'docker compose'
        // Si usas el binario viejo: 'docker-compose'
        // DOCKER_COMPOSE_CMD = 'docker-compose'
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Limpiando workspace..."
                deleteDir()
                echo "Clonando repositorio..."
                git branch: 'main',
                    url: 'https://github.com/jhossedmolina/eLibrary.git'
            }
        }

        stage('Build imagen Django') {
            steps {
                sh '''
                    # Limpiar por si quedó algo de un build anterior
                    ${DOCKER_COMPOSE_CMD} down -v || true

                    echo "Construyendo la imagen del servicio web..."
                    ${DOCKER_COMPOSE_CMD} build web
                '''
            }
        }

        stage('Levantar MySQL') {
            steps {
                sh '''
                    echo "Levantando solo el servicio de base de datos..."
                    ${DOCKER_COMPOSE_CMD} up -d db

                    echo "Estado de los contenedores:"
                    ${DOCKER_COMPOSE_CMD} ps
                '''
            }
        }

        stage('Migraciones y Tests Django') {
            steps {
                sh '''
                    echo "Esperando a que la base de datos esté lista..."
                    sleep 10
                    
                    echo "Ejecutando migraciones y tests dentro del contenedor Django (web)..."
                    ${DOCKER_COMPOSE_CMD} run --rm web sh -c "
                        python manage.py migrate &&
                        python manage.py test
                    "
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    echo "Desplegando aplicación..."
                    ${DOCKER_COMPOSE_CMD} up -d
                    
                    echo "Verificando servicios desplegados:"
                    ${DOCKER_COMPOSE_CMD} ps
                    
                    echo "✅ Aplicación disponible en http://localhost:8000"
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Pipeline exitoso. Aplicación desplegada correctamente."
        }
        failure {
            echo "❌ Pipeline falló. Ejecutando cleanup..."
            sh '${DOCKER_COMPOSE_CMD} down -v || true'
        }
    }
}